sensor:
  - platform: mqtt
    name: Zigbee2mqtt Bridge state
    state_topic: "zigbee2mqtt/bridge/state"
    icon: mdi:router-wireless

input_boolean:
  zigbee_permit_join:
    name: Allow devices to join
    initial: off
    icon: mdi:cellphone-wireless

input_select:
  zigbee2mqtt_log_level:
    name: Zigbee2mqtt Log Level
    options:
      - debug
      - info
      - warn
      - error
    initial: info
    icon: mdi:format-list-bulleted

switch:
  - platform: mqtt
    name: "Zigbee2mqtt Main join"
    state_topic: "zigbee2mqtt/bridge/config/permit_join"
    command_topic: "zigbee2mqtt/bridge/config/permit_join"
    payload_on: "true"
    payload_off: "false"

timer:
  zigbee_permit_join:
    name: Time remaining
    duration: 120

automation:
- id: zigbee2mqtt_log_level
  alias: Zigbee2mqtt Log Level
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_select.zigbee2mqtt_log_level
  action:
    - service: mqtt.publish
      data:
        payload_template: "{{ states('input_select.zigbee2mqtt_log_level') }}"
        topic: zigbee2mqtt/bridge/config/log_level

- id: enable_zigbee_join
  alias: Enable Zigbee joining
  hide_entity: true
  trigger:
    platform: state
    entity_id: input_boolean.zigbee_permit_join
    to: 'on'
  action:
  - service: mqtt.publish
    data:
      topic: zigbee2mqtt/bridge/config/permit_join
      payload: 'true'
  - service: timer.start
    data:
      entity_id: timer.zigbee_permit_join

- id: disable_zigbee_join
  alias: Disable Zigbee joining
  hide_entity: true
  trigger:
  - entity_id: input_boolean.zigbee_permit_join
    platform: state
    to: 'off'
  action:
  - data:
      payload: 'false'
      topic: zigbee2mqtt/bridge/config/permit_join
    service: mqtt.publish
  - data:
      entity_id: timer.zigbee_permit_join
    service: timer.cancel

- id: disable_zigbee_join_timer
  alias: Disable Zigbee joining by timer
  hide_entity: true
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.zigbee_permit_join
  action:
  - service: mqtt.publish
    data:
      topic: zigbee2mqtt/bridge/config/permit_join
      payload: 'false'
  - service: input_boolean.turn_off
    data:
      entity_id: input_boolean.zigbee_permit_join

- id: alert_zigbee_bridge_offline
  alias: 'Alarm wenn Zigbee2Mqtt offline'
  initial_state: 'on'
  trigger:
    - entity_id: sensor.zigbee2mqtt_bridge_state
      platform: state
      to: 'offline'
  action:
    - service: notify.kevin
      data:
        message: "Zigbee2Mqtt ist offline"

- id: alert_zigbee_bridge_online_again
  alias: 'Alarm wenn Zigbee2Mqtt wieder online'
  initial_state: 'on'
  trigger:
    - entity_id: sensor.zigbee2mqtt_bridge_state
      platform: state
      from: 'offline'
      to: 'online'
  action:
    - service: notify.kevin
      data:
        message: "Zigbee2Mqtt ist wieder online"
#################################################################
## Button Presses
#################################################################
- alias: Xiaomi Button Bar
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/0x00158d00021329bc'
  condition:
    condition: template
    value_template: '{{ "single" == trigger.payload_json.click }}'
  action:
    entity_id: light.bar_table
    service: light.toggle
- alias: Xiaomi Button Bad
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/0x00158d00012db9e5'
  condition:
    condition: template
    value_template: '{{ "single" == trigger.payload_json.click }}'
  action:
    entity_id: light.lower_bathroom_yeelight
    service: light.toggle  
- alias: Xiaomi Button Schlafzimmer
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/0x00158d0001b12a12'
  condition:
    condition: template
    value_template: '{{ "single" == trigger.payload_json.click }}'
  action:
    entity_id: light.bedroom_yeelight
    service: light.toggle  